<!-- Loading bar -->
<fuse-loading-bar></fuse-loading-bar>

<!-- Navigation -->
<fuse-vertical-navigation class="dark bg-gray-900 print:hidden" [mode]="isScreenSmall ? 'over' : 'side'"
    [name]="'mainNavigation'" [navigation]="navigation.default" [opened]="!isScreenSmall">
    <!-- Navigation header hook -->
    <ng-container fuseVerticalNavigationContentHeader>
        <div class="flex w-full items-center p-4 pl-6">
            <!-- Logo -->
            <div class="flex items-center justify-center">
                <img class="w-8" src="images/logo/LOGO-BN.png" />
            </div>
            <!-- Components -->
            <div class="ml-auto flex items-center">
                <notifications></notifications>
                <user [showAvatar]="false"></user>
            </div>
        </div>
        <!-- User -->
        <div class="flex w-full flex-col items-center p-4">
            <div class="relative h-24 w-24">
                @if (user?.avatar) {
                <img class="h-full w-full rounded-full" [src]="user.avatar" alt="User avatar" />
                }
                @if (!user?.avatar) {
                <mat-icon class="icon-size-24" [svgIcon]="'heroicons_solid:user-circle'"></mat-icon>
                }
            </div>
            <div class="mt-6 flex w-full flex-col items-center justify-center">
                <div
                    class="w-full overflow-hidden text-ellipsis whitespace-nowrap text-center font-medium leading-normal">
                    {{ user?.name }}
                </div>
                <div
                    class="text-secondary mt-0.5 w-full overflow-hidden text-ellipsis whitespace-nowrap text-center text-md font-medium leading-normal">
                    {{ user?.email }}
                </div>
            </div>
        </div>
    </ng-container>
    <!-- Navigation footer hook -->
    <ng-container fuseVerticalNavigationContentFooter>
        <div class="mb-4 mt-2 flex h-16 flex-0 items-center justify-center pl-2 pr-6 opacity-12">
            <img class="max-w-36" src="images/logo/LOGO-HORIZOLTAL-COLOR.png" />
        </div>
    </ng-container>
</fuse-vertical-navigation>

<!-- Wrapper -->
<div class="flex w-full min-w-0 flex-auto flex-col">
    <!-- Header -->
    <div
        class="bg-card relative z-49 flex h-16 w-full flex-0 items-center px-4 shadow dark:border-b dark:bg-transparent dark:shadow-none md:px-6 print:hidden">
        <!-- Navigation toggle button -->
        <button mat-icon-button (click)="toggleNavigation('mainNavigation')">
            <mat-icon [svgIcon]="'heroicons_outline:bars-3'"></mat-icon>
        </button>
        <!-- Components -->
        <div class="ml-auto flex items-center space-x-0.5 pl-2 sm:space-x-2">
            <div class="flex items-center ml-2 mr-1 sm:mr-4">
                <button mat-flat-button [color]="asistenciaStatus === 'ENTRADA' ? 'warn' : 'primary'"
                    class="rounded-full px-4 sm:px-6 h-10 transition-all duration-300 shadow-md border border-transparent active:scale-95"
                    [matMenuTriggerFor]="asistenciaMenu" matTooltip="Click para registrar asistencia">

                    <mat-icon class="icon-size-5 mr-0 sm:mr-2"
                        [svgIcon]="asistenciaStatus === 'ENTRADA' ? 'heroicons_outline:arrow-left-on-rectangle' : 'heroicons_outline:clock'">
                    </mat-icon>

                    <span class="hidden sm:inline font-semibold tracking-tight">
                        {{ asistenciaStatus === 'ENTRADA' ? 'MARCAR SALIDA' : 'MARCAR ENTRADA' }}
                    </span>
                    <span class="sm:hidden font-semibold">{{ asistenciaStatus === 'ENTRADA' ? 'SALIDA' : 'ENTRADA'
                        }}</span>
                </button>

                <mat-menu #asistenciaMenu="matMenu" class="p-4 w-72 rounded-2xl shadow-xl border border-gray-100"
                    (menuOpened)="solicitarPermisosUbicacion()">
                    <div class="flex flex-col p-2" (click)="$event.stopPropagation()">
                        <div class="text-lg font-bold mb-1 leading-tight text-gray-800 dark:text-white">Confirmar
                            Registro</div>

                        <!-- Estado: Obteniendo ubicaci√≥n -->
                        @if (locationPermission === 'pending') {
                        <div class="flex flex-col items-center justify-center py-6 gap-3">
                            <mat-spinner diameter="32"></mat-spinner>
                            <span class="text-sm text-secondary text-center">Solicitando permisos de ubicaci√≥n...</span>
                        </div>
                        }

                        <!-- Estado: Permisos denegados o GPS no disponible -->
                        @if (locationPermission === 'denied' || locationPermission === 'unavailable') {
                        <div class="flex flex-col items-center gap-3 py-4">
                            <div
                                class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 dark:bg-red-900">
                                <mat-icon class="text-red-500" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-semibold text-red-600 dark:text-red-400">Ubicaci√≥n no disponible
                                </p>
                                <p class="text-xs text-secondary mt-1 leading-snug">
                                    Para registrar asistencia debes <strong>permitir el acceso a tu ubicaci√≥n</strong>
                                    en la configuraci√≥n de tu navegador.
                                </p>
                            </div>
                            <button mat-stroked-button color="warn" class="w-full rounded-xl text-xs"
                                (click)="solicitarPermisosUbicacion()">
                                <mat-icon class="icon-size-4 mr-1"
                                    [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                                Reintentar
                            </button>
                        </div>
                        }

                        <!-- Estado: Ubicaci√≥n concedida -->
                        @if (locationPermission === 'granted') {
                        <div
                            class="flex items-start mt-2 mb-4 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                            <mat-icon class="icon-size-5 mr-2 text-blue-500 shrink-0"
                                [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-secondary">Ubicaci√≥n detectada</span>
                                <span class="text-xs leading-tight">{{ ubicacionNombre }}</span>
                            </div>
                        </div>

                        @if (asistenciaStatus !== 'ENTRADA') {
                        <button mat-flat-button color="primary"
                            class="w-full h-12 rounded-xl text-md font-bold shadow-sm"
                            (click)="ejecutarMarcaje('ENTRADA')">
                            CONFIRMAR ENTRADA
                        </button>
                        } @else {
                        <button mat-flat-button color="warn" class="w-full h-12 rounded-xl text-md font-bold shadow-sm"
                            (click)="ejecutarMarcaje('SALIDA')">
                            CONFIRMAR SALIDA
                        </button>
                        }
                        }

                        <div class="mt-4 text-center">
                            <span class="text-[10px] text-hint uppercase tracking-widest font-medium">JR Ingenier√≠a
                                El√©ctrica</span>
                        </div>
                    </div>
                </mat-menu>
            </div>

            <button mat-stroked-button class="google-btn" [ngClass]="{
    'google-logged-in': googleStatus?.isLoggedIn && !googleStatus?.isExpired,
    'google-expired': googleStatus?.isExpired,
    'google-not-logged': !googleStatus?.isLoggedIn
}" (click)="loginWithGoogle()">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon" />
            </button>

            <button mat-stroked-button class="google-btn flex items-center justify-center space-x-2" [ngClass]="{
    'google-logged-in': googleStatus?.isLoggedIn && !googleStatus?.isExpired,
    'google-expired': googleStatus?.isExpired,
    'google-not-logged': !googleStatus?.isLoggedIn
}" (click)="openGoogleEventsModal()" matTooltip="Abrir eventos de Google Calendar">
                <img src="https://www.gstatic.com/images/branding/product/1x/calendar_48dp.png" alt="Google Calendar"
                    class="google-calendar-icon" />
            </button>
            <!---languages></languages-->
            <button mat-icon-button (click)="toggleScheme()" matTooltip="Cambiar tema">
                @if (!isDark) {
                <mat-icon class="text-amber-500" [svgIcon]="'heroicons_outline:sun'"></mat-icon>
                } @else {
                <mat-icon class="text-blue-400" [svgIcon]="'heroicons_outline:moon'"></mat-icon>
                }
            </button>
            <fuse-fullscreen class="hidden md:block"></fuse-fullscreen>
            <!--search [appearance]="'bar'"></search-->
            <!--shortcuts></shortcuts>
            <messages></messages-->
            <!-- Bot√≥n de calendario -->
            <button mat-icon-button [matMenuTriggerFor]="calendarMenu">
                <mat-icon>calendar_today</mat-icon>
            </button>

            <button class="lg:hidden" mat-icon-button (click)="quickChat.toggle()">
                <mat-icon [svgIcon]="'heroicons_outline:chat-bubble-left-right'"></mat-icon>
            </button>

            <!-- üîπ Nuevo bot√≥n: Iniciar sesi√≥n con Google -->
            <button mat-stroked-button class="google-btn" [ngClass]="{
                'google-logged-in': googleStatus?.isLoggedIn && !googleStatus?.isExpired,
                'google-expired': googleStatus?.isExpired,
                'google-not-logged': !googleStatus?.isLoggedIn
            }" (click)="loginWithGoogle()">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon" />
            </button>

            <button mat-stroked-button class="google-btn flex items-center justify-center space-x-2" [ngClass]="{
                'google-logged-in': googleStatus?.isLoggedIn && !googleStatus?.isExpired,
                'google-expired': googleStatus?.isExpired,
                'google-not-logged': !googleStatus?.isLoggedIn
            }" (click)="openGoogleEventsModal()" matTooltip="Abrir eventos de Google Calendar">
                <img src="https://www.gstatic.com/images/branding/product/1x/calendar_48dp.png" alt="Google Calendar"
                    class="google-calendar-icon" />
            </button>




        </div>
    </div>

    <!-- Content -->
    <div class="flex flex-auto flex-col">
        <!-- *ngIf="true" hack is required here for router-outlet to work correctly.
             Otherwise, layout changes won't be registered and the view won't be updated! -->
        @if (true) {
        <router-outlet></router-outlet>
        }
    </div>

    <!-- Footer -->
    <!--<div class="relative flex flex-0 items-center justify-start w-full h-14 px-4 md:px-6 z-49 border-t bg-card dark:bg-transparent print:hidden">
        <span class="font-medium text-secondary">Fuse &copy; {{currentYear}}</span>
    </div>-->
</div>

<!-- Quick chat -->
<quick-chat #quickChat="quickChat"></quick-chat>

<!-- Modal de eventos de Google -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" *ngIf="showGoogleModal">
    <div
        class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-[98%] max-w-[1400px] max-h-[92vh] flex flex-col overflow-hidden relative">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b dark:border-gray-700">
            <div class="flex items-center space-x-3">
                <img src="https://www.gstatic.com/images/branding/product/1x/calendar_48dp.png" alt="Google Calendar"
                    class="google-calendar-icon-modal" />
                <h2 class="text-xl font-semibold">Google Calendar</h2>
            </div>
            <button mat-icon-button (click)="closeGoogleEventsModal()"
                class="text-gray-500 hover:text-red-500 transition">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <!-- Toolbar -->
        <div
            class="flex flex-wrap items-center justify-between gap-3 px-6 py-3 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700">
            <div class="flex flex-wrap gap-2">
                <button mat-raised-button color="primary" (click)="prev()">‚óÄÔ∏è Anterior</button>
                <button mat-raised-button color="accent" (click)="today()">üìÖ Hoy</button>
                <button mat-raised-button color="primary" (click)="next()">Siguiente ‚ñ∂Ô∏è</button>
            </div>

            <div class="text-center text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ currentDateLabel }}
            </div>

            <div class="flex flex-wrap gap-2">
                <button mat-stroked-button color="primary" (click)="changeView('month')">Mes</button>
                <button mat-stroked-button color="primary" (click)="changeView('week')">Semana</button>
                <button mat-stroked-button color="primary" (click)="changeView('day')">D√≠a</button>
                <button mat-flat-button color="warn" (click)="openAddEventForm()">
                    <mat-icon>add</mat-icon> Nuevo evento
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="flex-1 overflow-auto p-4">
            <!-- Cargando -->
            <div *ngIf="isLoadingGoogleEvents" class="flex flex-col items-center justify-center py-8">
                <mat-spinner diameter="40"></mat-spinner>
                <p class="mt-3 text-gray-500">Cargando eventos...</p>
            </div>

            <!-- Sin eventos -->
            <div *ngIf="!isLoadingGoogleEvents && (!googleEvents?.items || googleEvents.items.length === 0)"
                class="text-center text-gray-400 py-6">
                No se encontraron eventos en tu calendario.
            </div>

            <!-- Calendario -->
            <div #tuiCalendarContainer id="tui-calendar"
                class="w-full min-h-[600px] rounded-lg shadow-inner bg-white dark:bg-gray-800"></div>
        </div>
    </div>

    <!-- Modal para agregar nuevo evento -->
    <div *ngIf="showAddEventForm"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10000]">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-[95%] max-w-[500px] p-6 relative">
            <button mat-icon-button class="absolute top-2 right-2 text-gray-500 hover:text-red-500"
                (click)="closeAddEventForm()">
                <mat-icon>close</mat-icon>
            </button>

            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <mat-icon>event</mat-icon> Nuevo evento
            </h3>

            <form (ngSubmit)="saveNewEvent()" #eventForm="ngForm" class="space-y-4">
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>T√≠tulo</mat-label>
                    <input matInput [(ngModel)]="newEvent.title" name="title" required />
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Fecha inicio</mat-label>
                    <input matInput type="datetime-local" [(ngModel)]="newEvent.start" name="start" required />
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Fecha fin</mat-label>
                    <input matInput type="datetime-local" [(ngModel)]="newEvent.end" name="end" required />
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Descripci√≥n</mat-label>
                    <textarea matInput [(ngModel)]="newEvent.description" name="description"></textarea>
                </mat-form-field>

                <div class="flex justify-end gap-3 pt-4">
                    <button mat-stroked-button color="warn" type="button" (click)="closeAddEventForm()">
                        Cancelar
                    </button>
                    <button mat-flat-button color="primary" type="submit">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<mat-menu #calendarMenu="matMenu" (menuOpened)="onCalendarMenuOpened()">
    <div style="width: 700px; height: 600px;" (click)="$event.stopPropagation()" class="p-4">
        <app-tareas-calendar #fullCalendar [tareas]="misTareas"></app-tareas-calendar>
    </div>
</mat-menu>