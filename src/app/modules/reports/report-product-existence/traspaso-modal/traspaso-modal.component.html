<div class="p-6 flex flex-col gap-6 max-w-[600px] overflow-hidden">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-black text-gray-800 flex items-center gap-2 m-0 uppercase tracking-tighter">
            <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                <mat-icon>local_shipping</mat-icon>
            </div>
            Gestión de Traspaso Masivo
        </h2>
        <button mat-icon-button mat-dialog-close class="text-gray-400">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <!-- Lista de Productos -->
    <div class="bg-slate-800 p-4 rounded-2xl shadow-inner text-white max-h-[300px] overflow-y-auto custom-scroll">
        <p
            class="text-[9px] uppercase font-bold text-slate-400 leading-none mb-3 tracking-widest sticky top-0 bg-slate-800 py-1">
            Productos Seleccionados ({{productosSeleccionados.length}})
        </p>

        <div class="flex flex-col gap-3">
            <div *ngFor="let p of productosSeleccionados; let i = index"
                class="flex items-center justify-between gap-4 p-3 rounded-xl bg-white/5 border border-white/10">
                <div class="flex-grow min-w-0">
                    <p class="font-bold text-xs leading-tight uppercase truncate">{{p.nombreProducto}}</p>
                    <p class="text-[9px] text-slate-400 font-mono">{{p.codigoProducto}}</p>
                </div>

                <div class="flex items-center gap-2">
                    <div class="flex flex-col items-end">
                        <input type="number" [(ngModel)]="p.cantidadEnviar" (ngModelChange)="validarStockGlobal()"
                            class="w-16 bg-white/10 border border-white/20 rounded-lg px-2 py-1 text-xs font-black text-center focus:outline-none focus:border-blue-400"
                            [class.border-rose-500]="p.errorStock">
                        <p class="text-[8px] mt-1 uppercase font-bold" [class.text-rose-400]="p.errorStock"
                            [class.text-slate-500]="!p.errorStock">
                            Stock: {{p.stockMaximo || 'Sel. Origen'}}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración del Envío -->
    <div class="flex flex-col gap-4">
        <div class="grid grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
                <mat-label>Almacén Origen</mat-label>
                <mat-select [(ngModel)]="traspaso.idAlmacenOrigen" (selectionChange)="onOrigenChange()" name="origen">
                    <mat-option [value]="1">QUERÉTARO</mat-option>
                    <mat-option [value]="2">PACHUCA</mat-option>
                    <mat-option [value]="3">PUEBLA</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
                <mat-label>Almacén Destino</mat-label>
                <mat-select [(ngModel)]="traspaso.idAlmacenDestino" (selectionChange)="onDestinoChange()"
                    name="destino">
                    <mat-option [value]="1" [disabled]="traspaso.idAlmacenOrigen === 1">QUERÉTARO</mat-option>
                    <mat-option [value]="2" [disabled]="traspaso.idAlmacenOrigen === 2">PACHUCA</mat-option>
                    <mat-option [value]="3" [disabled]="traspaso.idAlmacenOrigen === 3">PUEBLA</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
                <mat-label>Paquetería / Envío</mat-label>
                <mat-select [(ngModel)]="traspaso.paqueteria" name="paqueteria">
                    <mat-option *ngFor="let paq of paqueterias" [value]="paq">
                        {{paq}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
                <mat-label>Responsable en Destino</mat-label>
                <mat-select [(ngModel)]="traspaso.idUsuarioDestino" name="usuarioDestino">
                    <mat-option *ngFor="let user of usuarios" [value]="user.usuarioId">
                        {{user.nombreUsuario}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
            <mat-label>Observaciones (Opcional)</mat-label>
            <textarea matInput [(ngModel)]="traspaso.observaciones" rows="2"
                placeholder="Notas adicionales sobre el envío..."></textarea>
        </mat-form-field>
    </div>

    <div class="flex flex-col gap-3 mt-4">
        <button mat-flat-button class="!h-14 !rounded-2xl !text-white shadow-xl transition-all duration-300"
            [class.!bg-slate-300]="esInvalido || loading" [class.!bg-blue-700]="!esInvalido && !loading"
            [disabled]="esInvalido || loading" (click)="confirmarTraspaso()">

            <div class="flex items-center justify-center gap-3" *ngIf="!loading">
                <mat-icon>send</mat-icon>
                <span class="font-black tracking-widest text-xs uppercase">Confirmar Envío Masivo</span>
            </div>
            <mat-spinner diameter="24" *ngIf="loading" class="mx-auto" color="accent"></mat-spinner>
        </button>
    </div>
</div>