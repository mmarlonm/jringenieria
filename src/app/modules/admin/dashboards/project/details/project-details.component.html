<div class="absolute inset-0 flex flex-col overflow-hidden p-6">
  <h1 class="text-2xl font-bold mb-4">
    {{ projectId ? "Editar Proyecto" : "Nuevo Proyecto" }}
  </h1>

  <mat-tab-group class="h-full flex-1 overflow-hidden" (selectedTabChange)="onTabChange($event)">
    <!-- TAB 1: Información General -->
    <mat-tab label="Información General">
      <div class="w-full gap-4 mb-4">
        <app-neumorphic-progress [value]="progressValue"></app-neumorphic-progress>
      </div>

      <form [formGroup]="projectForm" class="flex flex-col gap-4">

        <!-- Pago Total y Anticipo (con botón historial) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Pago Total</mat-label>
            <input matInput type="text" [value]="pagoTotalDisplay" (blur)="onPagoTotalBlur($event)"
              (input)="onPagoTotalInput($event)" />
          </mat-form-field>

          <div class="flex items-center gap-2">
            <mat-form-field appearance="fill" class="flex-1">
              <mat-label>Anticipo</mat-label>
              <input matInput type="text" [value]="anticipoDisplay" (blur)="onAnticipoBlur($event)"
                (input)="onAnticipoInput($event)" />
            </mat-form-field>
            <button mat-icon-button color="primary" (click)="mostrarHistorial = !mostrarHistorial">
              <mat-icon>history</mat-icon>
            </button>
          </div>
        </div>

        <!-- Nombre de Proyecto -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Nombre del Proyecto</mat-label>
          <input matInput formControlName="nombre" />
        </mat-form-field>

        <!-- Dirección -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Dirección</mat-label>
          <input matInput formControlName="direccion" />
        </mat-form-field>

        <!-- Empresa -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Empresa</mat-label>
          <input matInput formControlName="empresa" />
        </mat-form-field>

        <!-- Archivos antes (OC, Cotización, Fianzas, Contrato, Pólizas) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <ng-container *ngFor="let categoria of categoriasInputsParte1">
            <mat-form-field appearance="fill" class="w-full flex items-center gap-2">
              <mat-label>{{ categoria.label }}</mat-label>
              <input matInput [value]="getArchivoNombre(categoria.key)" readonly />
              <button mat-icon-button type="button"
                (click)="hasArchivoGuardado(categoria.key) ? descargarArchivoGuardado(categoria.key) : fileInputs[categoria.key].click()">
                <mat-icon>{{ hasArchivoGuardado(categoria.key) ? 'cloud_download' : 'attach_file' }}</mat-icon>
              </button>
              <button *ngIf="hasArchivoGuardado(categoria.key)" mat-icon-button color="warn" type="button"
                (click)="eliminarArchivo(categoria.key)">
                <mat-icon>delete</mat-icon>
              </button>
              <input type="file" [attr.data-key]="categoria.key" #fileInput
                (change)="onFileSelectedOne($event, categoria.key)" hidden />
            </mat-form-field>
          </ng-container>
        </div>

        <!-- Fechas de Inicio y Fin -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Fecha de Inicio</mat-label>
            <input matInput [matDatepicker]="picker1" formControlName="fechaInicio" />
            <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
            <mat-datepicker #picker1></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Fecha de Fin</mat-label>
            <input matInput [matDatepicker]="picker2" formControlName="fechaFin" />
            <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
            <mat-datepicker #picker2></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Contacto Responsable del Proyecto (Cliente) -->
        <h3 class="font-semibold text-lg mt-4">Contacto Responsable del Proyecto (Cliente)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="fill">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombreContactoCliente" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Área/Departamento</mat-label>
            <input matInput formControlName="areaContactoCliente" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Teléfono</mat-label>
            <input matInput formControlName="telefonoContactoCliente" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Correo</mat-label>
            <input matInput formControlName="correoContactoCliente" />
          </mat-form-field>
        </div>

        <!-- Contacto Supervisor en Campo (Cliente) -->
        <h3 class="font-semibold text-lg mt-4">Supervisor en Campo (Cliente)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="fill">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombreSupervisorCliente" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Área/Departamento</mat-label>
            <input matInput formControlName="areaSupervisorCliente" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Teléfono</mat-label>
            <input matInput formControlName="telefonoSupervisorCliente" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Correo</mat-label>
            <input matInput formControlName="correoSupervisorCliente" />
          </mat-form-field>
        </div>

        <!-- Responsable del Proyecto JR -->
        <h3 class="font-semibold text-lg mt-4">Responsable del Proyecto JR</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="fill">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombreResponsableJR" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Área/Departamento</mat-label>
            <input matInput formControlName="areaResponsableJR" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Teléfono</mat-label>
            <input matInput formControlName="telefonoResponsableJR" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Correo</mat-label>
            <input matInput formControlName="correoResponsableJR" />
          </mat-form-field>
        </div>

        <!-- Responsable Campo JR -->
        <h3 class="font-semibold text-lg mt-4">Responsable de Campo JR</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="fill">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombreCampoJR" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Área/Departamento</mat-label>
            <input matInput formControlName="areaCampoJR" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Teléfono</mat-label>
            <input matInput formControlName="telefonoCampoJR" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Correo</mat-label>
            <input matInput formControlName="correoCampoJR" />
          </mat-form-field>
        </div>

        <!-- Integrantes del Equipo Ejecutor -->
        <h3 class="font-semibold text-lg mt-4">Integrantes del Equipo Ejecutor</h3>
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Integrantes del Equipo</mat-label>
          <mat-chip-list #chipList aria-label="Seleccionar personas">
            <mat-chip *ngFor="let persona of personasSeleccionadas" [removable]="true"
              (removed)="removePersona(persona)">
              {{ persona.nombreUsuario }}
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
            <input matInput [matAutocomplete]="auto" [formControl]="personasControl" placeholder="Buscar usuario" />
          </mat-chip-list>
          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="addPersonaFromAutoComplete($event)">
            <mat-option *ngFor="let usuario of filteredUsers | async" [value]="usuario">
              {{ usuario.nombreUsuario }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <!-- Archivos después (Programa de trabajo a Comentarios) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <ng-container *ngFor="let categoria of categoriasInputsParte2">
            <mat-form-field appearance="fill" class="w-full flex items-center gap-2">
              <mat-label>{{ categoria.label }}</mat-label>
              <input matInput [value]="getArchivoNombre(categoria.key)" readonly />
              <button mat-icon-button type="button"
                (click)="hasArchivoGuardado(categoria.key) ? descargarArchivoGuardado(categoria.key) : fileInputs[categoria.key].click()">
                <mat-icon>{{ hasArchivoGuardado(categoria.key) ? 'cloud_download' : 'attach_file' }}</mat-icon>
              </button>
              <button *ngIf="hasArchivoGuardado(categoria.key)" mat-icon-button color="warn" type="button"
                (click)="eliminarArchivo(categoria.key)">
                <mat-icon>delete</mat-icon>
              </button>
              <input type="file" [attr.data-key]="categoria.key" #fileInput
                (change)="onFileSelectedOne($event, categoria.key)" hidden />
            </mat-form-field>
          </ng-container>
        </div>

      </form>

    </mat-tab>


    <!-- TAB 2: Archivos del Proyecto -->
    <mat-tab label="Archivos del Proyecto" [disabled]="disabledArchivos">
      <div class="flex flex-col gap-4 h-[65vh] md:h-[80vh] lg:h-[80vh] overflow-auto pr-2">
        <div class="absolute inset-0 flex min-w-0 flex-col">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 p-2">
            <!-- Cada input en una celda de la grid -->
            <!-- Plano Arquitectónico -->
            <div class="flex items-center gap-1">
              <label class="w-40">Plano Arquitectónico:</label>
              <button mat-stroked-button type="button" (click)="planoArquitectonicoInput.click()">
                Subir archivo
              </button>
              <span *ngIf="levantamientoFile?.name" class="text-sm text-gray-600 truncate max-w-[200px]"></span>
              <input type="file" accept=".pdf,.doc,.docx,.jpg,.png" #planoArquitectonicoInput
                (change)="onFileSelected($event, 'plano arquitectonico')" hidden />
            </div>

            <!-- Diagrama Unifilar -->
            <div class="flex items-center gap-3">
              <label class="w-40">Diagrama Unifilar:</label>
              <button mat-stroked-button type="button" (click)="diagramaUnifilarInput.click()">
                Subir archivo
              </button>
              <span *ngIf="levantamientoFile?.name" class="text-sm text-gray-600 truncate max-w-[200px]"></span>
              <input type="file" accept=".pdf,.doc,.docx,.jpg,.png" #diagramaUnifilarInput
                (change)="onFileSelected($event, 'diagrama unifilar')" hidden />
            </div>

            <!-- Repite la misma estructura para los demás -->
            <!-- Diagrama Isométrico -->
            <div class="flex items-center gap-3">
              <label class="w-40">Diagrama Isométrico:</label>
              <button mat-stroked-button type="button" (click)="diagramaIsometricoInput.click()">
                Subir archivo
              </button>
              <span *ngIf="levantamientoFile?.name" class="text-sm text-gray-600 truncate max-w-[200px]"></span>
              <input type="file" accept=".pdf,.doc,.docx,.jpg,.png" #diagramaIsometricoInput
                (change)="onFileSelected($event, 'diagrama isometrico')" hidden />
            </div>

            <!-- Lista de materiales -->
            <div class="flex items-center gap-3">
              <label class="w-40">Lista de materiales:</label>
              <button mat-stroked-button type="button" (click)="listaMaterialesInput.click()">
                Subir archivo
              </button>
              <span *ngIf="levantamientoFile?.name" class="text-sm text-gray-600 truncate max-w-[200px]"></span>
              <input type="file" accept=".pdf,.doc,.docx,.xls,.xlsx" #listaMaterialesInput
                (change)="onFileSelected($event, 'Lista de materiales')" hidden />
            </div>

            <!-- Levantamiento -->
            <div class="flex items-center gap-3">
              <label class="w-40">Levantamiento:</label>
              <button mat-stroked-button type="button" (click)="levantamientoInput.click()">
                Subir archivo
              </button>
              <span *ngIf="levantamientoFile?.name" class="text-sm text-gray-600 truncate max-w-[200px]"></span>
              <input type="file" accept=".pdf,.doc,.docx,.jpg,.png" #levantamientoInput
                (change)="onFileSelected($event, 'levantamiento')" hidden />
            </div>

            <!-- Fotos -->
            <div class="flex items-center gap-3">
              <label class="w-40">Fotos:</label>
              <button mat-stroked-button type="button" (click)="fotosInput.click()">
                Subir archivo
              </button>
              <span *ngIf="levantamientoFile?.name" class="text-sm text-gray-600 truncate max-w-[200px]"></span>
              <input type="file" accept="image/*" #fotosInput (change)="onFileSelected($event, 'fotos')" hidden />
            </div>
          </div>

          <!-- Lista de Archivos -->
          <div class="space-y-8 p-6 md:p-8">
            @if (files.length > 0) {
            <div>
              <div class="font-medium">Files</div>
              <div class="-m-2 mt-2 flex flex-wrap">
                @for (file of files; track trackByFn($index, file)) {
                <div class="relative m-2">
                  <!-- Card de archivo -->
                  <a class="absolute right-1.5 top-1.5 z-20 h-10 min-h-10 w-8" (click)="
                          deleteFile(
                            file.proyectoId,
                            file.categoria,
                            file.nombreArchivo
                          )
                        " mat-icon-button>
                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:trash'"></mat-icon>
                  </a>
                  <a class="bg-card flex h-40 w-50 cursor-pointer flex-col rounded-2xl p-4 shadow" (click)="
                          downloadFile(
                            file.proyectoId,
                            file.categoria,
                            file.nombreArchivo
                          )
                        ">
                    <div class="aspect-[9/6]">
                      {{ file.categoria }}
                      <div class="flex h-full items-center justify-center">
                        <div class="relative">
                          <mat-icon class="text-hint opacity-50 icon-size-14"
                            [svgIcon]="'heroicons_solid:document'"></mat-icon>
                          <div
                            class="absolute bottom-0 left-0 rounded px-1.5 text-sm font-semibold leading-5 text-white"
                            [class.bg-red-600]="file.type === 'PDF'" [class.bg-blue-600]="file.type === 'DOC'"
                            [class.bg-green-600]="file.type === 'XLS'" [class.bg-gray-600]="file.type === 'TXT'"
                            [class.bg-amber-600]="file.type === 'JPG'" [class.bg-orange-600]="file.type === 'PNG'">
                            {{ file.type.toUpperCase() }}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="flex flex-auto flex-col justify-center text-center text-sm font-medium">
                      <div class="truncate" [matTooltip]="file.name">
                        {{ file.nombreArchivo }}
                      </div>
                    </div>
                  </a>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Evidencias del Proyecto" [disabled]="disabledArchivos">
      <div class="flex flex-col gap-4 h-[70vh] md:h-[80vh] lg:h-[80vh] overflow-auto pr-2">
        <div class="absolute inset-0 flex min-w-0 flex-col">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4">
            <!-- Fotos -->
            <div class="flex items-center gap-3">
              <label class="w-40">Fotos con camara:</label>
              <button mat-stroked-button type="button" (click)="fotosCamaraInput.click()">
                Tomar foto
              </button>
              <span *ngIf="levantamientoFile?.name" class="text-sm text-gray-600 truncate max-w-[200px]"></span>
              <input type="file" accept="image/*" capture="environment" #fotosCamaraInput
                (change)="onFileSelected($event, 'Evidencias')" hidden />
            </div>
          </div>

          <!-- Lista de Archivos -->
          <div class="space-y-8 p-6 md:p-8">
            @if (filesEvidencias.length > 0) {
            <div>
              <div class="font-medium">Files</div>
              <div class="-m-2 mt-2 flex flex-wrap">
                @for (
                file of filesEvidencias;
                track trackByFn($index, file)
                ) {
                <div class="relative m-2">
                  <!-- Card de archivo -->
                  <a class="absolute right-1.5 top-1.5 z-20 h-10 min-h-10 w-8" (click)="
                          deleteFile(
                            file.proyectoId,
                            file.categoria,
                            file.nombreArchivo
                          )
                        " mat-icon-button>
                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:trash'"></mat-icon>
                  </a>
                  <a class="bg-card flex h-40 w-50 cursor-pointer flex-col rounded-2xl p-4 shadow" (click)="
                          downloadFile(
                            file.proyectoId,
                            file.categoria,
                            file.nombreArchivo
                          )
                        ">
                    <div class="aspect-[9/6]">
                      {{ file.categoria }}
                      <div class="flex h-full items-center justify-center">
                        <div class="relative">
                          <mat-icon class="text-hint opacity-50 icon-size-14"
                            [svgIcon]="'heroicons_solid:document'"></mat-icon>
                          <div
                            class="absolute bottom-0 left-0 rounded px-1.5 text-sm font-semibold leading-5 text-white"
                            [class.bg-red-600]="file.type === 'PDF'" [class.bg-blue-600]="file.type === 'DOC'"
                            [class.bg-green-600]="file.type === 'XLS'" [class.bg-gray-600]="file.type === 'TXT'"
                            [class.bg-amber-600]="file.type === 'JPG'" [class.bg-orange-600]="file.type === 'PNG'">
                            {{ file.type.toUpperCase() }}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="flex flex-auto flex-col justify-center text-center text-sm font-medium">
                      <div class="truncate" [matTooltip]="file.name">
                        {{ file.nombreArchivo }}
                      </div>
                    </div>
                  </a>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Gantt Chart">
      <div class="gantt-wrapper">
        <!-- Formulario arriba -->
        <form [formGroup]="taskForm" (ngSubmit)="addTask()" class="gantt-form">
          <mat-form-field appearance="fill">
            <mat-label>Nombre de la tarea</mat-label>
            <input matInput formControlName="name" />
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput [matDatepicker]="pickerStart" formControlName="start" />
            <mat-datepicker-toggle matSuffix [for]="pickerStart"></mat-datepicker-toggle>
            <mat-datepicker #pickerStart></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Fecha Fin</mat-label>
            <input matInput [matDatepicker]="pickerEnd" formControlName="end" />
            <mat-datepicker-toggle matSuffix [for]="pickerEnd"></mat-datepicker-toggle>
            <mat-datepicker #pickerEnd></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Dependencias</mat-label>
            <mat-select formControlName="dependencies" multiple>
              <mat-option *ngFor="let t of tasks" [value]="t.id">{{ t.name }}</mat-option>
            </mat-select>
          </mat-form-field>



          <button mat-raised-button color="primary" type="submit" [disabled]="taskForm.invalid">
            Agregar tarea
          </button>

          <mat-form-field appearance="fill">
            <mat-label>Modo de vista</mat-label>
            <mat-select [(value)]="viewMode" (selectionChange)="changeView($event.value)">
              <mat-option value="Day">Día</mat-option>
              <mat-option value="Week">Semana</mat-option>
              <mat-option value="Month">Mes</mat-option>
            </mat-select>
          </mat-form-field>
        </form>

        <!-- Gantt chart abajo -->
        <div>
          <div class="gantt-container">
            <div id="gantt"></div>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
  <!-- Botones -->
  <div class="flex justify-end gap-2 mb-4 btn-float z-99">
    <button mat-raised-button color="primary" type="submit" (click)="saveProject()">
      Guardar
    </button>
    <button mat-button color="warn" type="button" (click)="router.navigate(['/dashboards/project'])">
      Cancelar
    </button>
  </div>
</div>
<ng-template #editTaskDialog let-data>
  <h2 mat-dialog-title>Editar Tarea</h2>
  <mat-dialog-content [formGroup]="editForm">

    <!-- Nombre -->
    <mat-form-field appearance="fill" style="width: 100%;">
      <mat-label>Nombre</mat-label>
      <input matInput formControlName="name" />
    </mat-form-field>

    <!-- Progreso -->
    <mat-form-field appearance="fill" style="width: 100%;">
      <mat-label>Progreso (%)</mat-label>
      <input matInput type="number" formControlName="progress" min="0" max="100" />
    </mat-form-field>

    <!-- Fecha inicio -->
    <mat-form-field appearance="fill" style="width: 100%;">
      <mat-label>Fecha de inicio</mat-label>
      <input matInput [matDatepicker]="startPicker" formControlName="start" />
      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>

    <!-- Fecha fin -->
    <mat-form-field appearance="fill" style="width: 100%;">
      <mat-label>Fecha de fin</mat-label>
      <input matInput [matDatepicker]="endPicker" formControlName="end" />
      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>

    <!-- Equipo -->
    <mat-form-field appearance="fill" style="width: 100%;">
      <mat-label>Equipo</mat-label>
      <input matInput formControlName="equipo" />
    </mat-form-field>

    <!-- Dependencias -->
    <mat-form-field appearance="fill" class="w-full">
      <mat-label>Dependencias</mat-label>
      <mat-select formControlName="dependencies" multiple>
        <mat-option *ngFor="let t of tasks" [value]="t.id">{{ t.name }}</mat-option>
      </mat-select>
    </mat-form-field>

  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="closeDialog()">Cancelar</button>
    <button mat-button color="warn" (click)="deleteTask()">Eliminar</button>
    <button mat-button color="primary" (click)="saveTaskEdit()">Guardar</button>
  </mat-dialog-actions>
</ng-template>

<!-- Overlay oscuro semi-transparente -->
<div *ngIf="mostrarHistorial" class="modal-overlay" (click)="mostrarHistorial = false"></div>

<!-- Modal flotante centrado -->
<div *ngIf="mostrarHistorial" class="modal-container" (click)="$event.stopPropagation()">
  <h3 class="text-lg font-semibold mb-2">Historial de Anticipos</h3>
  <ul class="list-disc list-inside max-h-60 overflow-auto">
    <li *ngFor="let pago of obtenerHistorial()">{{ pago | currency:'MXN':'symbol' }}</li>
  </ul>
  <div class="mt-2 font-bold">
    Total Anticipado: {{ calcularTotalAnticipos() | currency:'MXN':'symbol' }}
  </div>
  <button mat-raised-button color="warn" (click)="mostrarHistorial = false">Cerrar</button>
</div>