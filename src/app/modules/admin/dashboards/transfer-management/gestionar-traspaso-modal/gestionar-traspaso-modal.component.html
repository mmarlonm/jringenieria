<div class="p-6 flex flex-col gap-6 max-w-[500px] max-h-[90vh] overflow-y-auto custom-scroll">

    <!-- Header -->
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-black text-main flex items-center gap-2 m-0 uppercase tracking-tighter">
            <div class="p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg">
                <mat-icon>{{ traspaso.estadoId === 1 ? 'local_shipping' : 'done_all' }}</mat-icon>
            </div>
            {{ traspaso.estadoId === 1 ? 'Procesar Envío' : 'Aprobar Recepción' }}
        </h2>
        <button mat-icon-button mat-dialog-close class="text-secondary">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <!-- Info del Traspaso (Banner Tenue) -->
    <div class="bg-default p-4 rounded-2xl border dark:border-gray-800">
        <div class="flex justify-between items-start mb-2">
            <div>
                <p class="text-[10px] uppercase font-black text-hint leading-none mb-1 tracking-widest">Folio</p>
                <p class="text-sm font-bold text-blue-600 dark:text-blue-400 font-mono">#{{traspaso.folio}}</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] uppercase font-black text-hint leading-none mb-1 tracking-widest">Destino</p>
                <p class="text-xs font-bold text-main leading-tight uppercase">{{traspaso.almacenDestinoNombre}}
                </p>
            </div>
        </div>
        <p class="text-[10px] text-secondary italic mt-2 border-t pt-2 border-divider">
            {{traspaso.observaciones || 'Sin observaciones de origen'}}
        </p>
    </div>

    <!-- ============================================= -->
    <!-- VISTA A: PROCESAR ENVÍO (Solicitado -> 1)     -->
    <!-- ============================================= -->
    <ng-container *ngIf="traspaso.estadoId === 1">
        <div class="flex flex-col gap-4">
            <div class="grid grid-cols-1 gap-4">
                <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
                    <mat-label>Transportista / Paquetería</mat-label>
                    <input matInput [(ngModel)]="datosEnvio.transportista" placeholder="Ej. Paquetexpress, DHL...">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
                    <mat-label>Guía de Rastreo</mat-label>
                    <input matInput [(ngModel)]="datosEnvio.guiaRastreo" placeholder="Número de guía...">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full !mb-[-1.25em]">
                    <mat-label>Folio Contpaqi</mat-label>
                    <input matInput [(ngModel)]="datosEnvio.folioContpaqi" placeholder="Ej. TR-1234...">
                </mat-form-field>
            </div>

            <!-- Upload Evidencia Envío -->
            <div class="flex flex-col gap-2 mt-2">
                <span class="text-[10px] font-black uppercase text-secondary tracking-widest leading-none">
                    Evidencia Contpaqi (Obligatorio)
                </span>
                <div class="flex items-center gap-3">
                    <button mat-stroked-button color="primary" class="!rounded-xl !h-12 flex-grow dark:border-gray-700"
                        (click)="fileInputEnvio.click()" [disabled]="subiendoArchivo">
                        <mat-icon>{{ datosEnvio.urlEvidenciaEnvio ? 'task_alt' : 'cloud_upload' }}</mat-icon>
                        {{ datosEnvio.urlEvidenciaEnvio ? 'PDF CARGADO' : 'SUBIR PDF CONTPAQI' }}
                    </button>
                    <mat-spinner diameter="20" *ngIf="subiendoArchivo"></mat-spinner>
                    <input #fileInputEnvio type="file" (change)="onFileSelected($event, 'ENVIO')"
                        accept="application/pdf" class="hidden">
                </div>
                <p *ngIf="datosEnvio.urlEvidenciaEnvio"
                    class="text-[9px] text-emerald-600 dark:text-emerald-400 font-bold uppercase truncate">
                    <mat-icon class="!text-[12px] !w-3 !h-3 align-middle">link</mat-icon> Archivo listo para enviar
                </p>
            </div>

            <button mat-flat-button class="!h-14 !rounded-2xl !text-white shadow-xl mt-4 transition-all"
                [ngClass]="esEnvioInvalido ? '!bg-slate-300 dark:!bg-gray-800 !text-slate-500' : '!bg-blue-600 hover:!bg-blue-700'"
                [disabled]="esEnvioInvalido || loading" (click)="confirmarEnvio()">
                <div class="flex items-center justify-center gap-2" *ngIf="!loading">
                    <mat-icon>local_shipping</mat-icon>
                    <span class="font-black tracking-widest text-xs uppercase">Confirmar Salida</span>
                </div>
                <mat-spinner diameter="24" *ngIf="loading" class="mx-auto" color="white"></mat-spinner>
            </button>
        </div>
    </ng-container>

    <!-- ============================================= -->
    <!-- VISTA B: APROBAR RECEPCIÓN (En Tránsito -> 4) -->
    <!-- ============================================= -->
    <ng-container *ngIf="traspaso.estadoId === 4">
        <div class="flex flex-col gap-4">

            <div
                class="bg-amber-50 dark:bg-amber-900/10 p-4 rounded-2xl border border-amber-100 dark:border-amber-800/50 flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-amber-800 dark:text-amber-200 leading-tight">¿Material incompleto o
                        dañado?</p>
                    <p class="text-[10px] text-amber-600 dark:text-amber-400">Reporta cualquier anomalía en la recepción
                    </p>
                </div>
                <mat-slide-toggle [(ngModel)]="datosRecepcion.conDiferencias" color="warn"></mat-slide-toggle>
            </div>


            <mat-form-field appearance="outline" class="w-full">
                <mat-label>Observaciones de Recepción</mat-label>
                <textarea matInput [(ngModel)]="datosRecepcion.observaciones" rows="3"
                    [placeholder]="datosRecepcion.conDiferencias ? 'Describe detalladamente las diferencias...' : 'Notas adicionales...'"></textarea>
                <mat-hint *ngIf="datosRecepcion.conDiferencias"
                    class="text-red-500 dark:text-red-400 font-bold text-[10px] uppercase">
                    Obligatorio al reportar diferencias
                </mat-hint>
            </mat-form-field>

            <!-- Upload Evidencia Recepción -->
            <div class="flex flex-col gap-2">
                <span class="text-[10px] font-black uppercase text-secondary tracking-widest leading-none">
                    Acuse de Recibo Firmado (Opcional)
                </span>
                <div class="flex items-center gap-3">
                    <button mat-stroked-button color="accent" class="!rounded-xl !h-12 flex-grow dark:border-gray-700"
                        (click)="fileInputRecibo.click()" [disabled]="subiendoArchivo">
                        <mat-icon>{{ datosRecepcion.urlEvidenciaRecepcion ? 'photo_camera' : 'upload_file' }}</mat-icon>
                        {{ datosRecepcion.urlEvidenciaRecepcion ? 'ACUSE CARGADO' : 'SUBIR ACUSE / FOTO' }}
                    </button>
                    <mat-spinner diameter="20" *ngIf="subiendoArchivo"></mat-spinner>
                    <input #fileInputRecibo type="file" (change)="onFileSelected($event, 'RECEPCION')"
                        accept="image/*,application/pdf" class="hidden">
                </div>
            </div>

            <button mat-flat-button class="!h-14 !rounded-2xl !text-white shadow-xl mt-4 transition-all"
                [ngClass]="esRecepcionInvalida ? '!bg-slate-300 dark:!bg-gray-800 !text-slate-500' : '!bg-emerald-600 hover:!bg-emerald-700'"
                [disabled]="esRecepcionInvalida || loading" (click)="confirmarRecepcion()">
                <div class="flex items-center justify-center gap-2" *ngIf="!loading">
                    <mat-icon>check_circle</mat-icon>
                    <span class="font-black tracking-widest text-xs uppercase">Aprobar Recepción</span>
                </div>
                <mat-spinner diameter="24" *ngIf="loading" class="mx-auto" color="white"></mat-spinner>
            </button>
        </div>
    </ng-container>

</div>