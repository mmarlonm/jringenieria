<div class="w-full p-6 bg-default min-h-screen">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-black text-main tracking-tighter uppercase flex items-center gap-2 m-0">
                <mat-icon class="text-blue-600 dark:text-blue-400 scale-125">swap_horiz</mat-icon>
                Gestión de Traspasos
            </h1>
            <p class="text-secondary text-sm italic">Control de movimientos entre sucursales y almacenes.</p>
        </div>
        <button mat-flat-button color="primary" class="!rounded-xl !h-11 shadow-lg hover:scale-105 transition-transform"
            (click)="consultar()">
            <mat-icon>refresh</mat-icon> ACTUALIZAR
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div
            class="bg-card p-6 rounded-3xl border dark:border-gray-800 shadow-sm flex justify-between items-center group hover:border-blue-200 dark:hover:border-blue-500/50 transition-colors">
            <div>
                <p class="text-secondary text-xs font-bold uppercase tracking-widest">Total Historial</p>
                <h2 class="text-3xl font-black m-0 text-main">{{transfers.length}}</h2>
            </div>
            <mat-icon
                class="text-slate-100 dark:text-gray-800 scale-[2.5] group-hover:text-blue-50 dark:group-hover:text-blue-900/30 transition-colors">inventory_2</mat-icon>
        </div>
        <div
            class="bg-card p-6 rounded-3xl border dark:border-gray-800 shadow-sm flex justify-between items-center group hover:border-amber-200 dark:hover:border-amber-500/50 transition-colors">
            <div>
                <p class="text-secondary text-xs font-bold uppercase tracking-widest text-amber-500">Pendientes por
                    recibir</p>
                <h2 class="text-3xl font-black m-0 text-amber-500">{{ pendingCount }}</h2>
            </div>
            <mat-icon
                class="text-amber-50 dark:text-amber-900/20 group-hover:text-amber-100 dark:group-hover:text-amber-800/40 scale-[2.5] transition-colors">pending_actions</mat-icon>
        </div>
    </div>

    <div class="bg-card rounded-3xl border dark:border-gray-800 shadow-sm overflow-hidden mb-6">
        <div class="overflow-x-auto">
            <table mat-table [dataSource]="transfers" class="w-full">

                <!-- Folio Column -->
                <ng-container matColumnDef="folio">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-default dark:bg-gray-800/50 text-secondary font-black text-[10px] uppercase tracking-widest px-4 py-4 border-b dark:border-gray-800">
                        Folio
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-4 py-4 border-b dark:border-gray-800">
                        <button class="flex items-center group" (click)="verDetalle(row)"
                            matTooltip="Ver proceso completo">
                            <span
                                class="font-mono font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-100 dark:border-blue-800 text-[11px] group-hover:bg-blue-600 group-hover:text-white transition-colors cursor-pointer">
                                #{{row.folio}}
                            </span>
                        </button>
                    </td>
                </ng-container>

                <!-- Responsable Origen -->
                <ng-container matColumnDef="envia">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-default dark:bg-gray-800/50 text-secondary font-black text-[10px] uppercase tracking-widest px-4 py-4 border-b dark:border-gray-800">
                        Responsable Origen
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-4 py-4 border-b dark:border-gray-800">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full flex items-center justify-center text-[11px] font-black text-white shadow-inner ring-2 ring-card overflow-hidden"
                                [style.background-color]="getUserDisplay(row.responsableOrigenId).color"
                                [matTooltip]="getUserDisplay(row.responsableOrigenId).name">
                                <img *ngIf="getUserDisplay(row.responsableOrigenId).avatar"
                                    [src]="getUserDisplay(row.responsableOrigenId).avatar"
                                    class="w-full h-full object-cover">
                                <span *ngIf="!getUserDisplay(row.responsableOrigenId).avatar">
                                    {{ getUserDisplay(row.responsableOrigenId).initials }}
                                </span>
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span
                                    class="text-[9px] font-bold text-hint uppercase tracking-tighter leading-none mb-1">Origen</span>
                                <span class="text-[10px] font-bold text-main truncate max-w-[100px]">{{
                                    row.almacenOrigenNombre }}</span>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Destinatario (Recibe) -->
                <ng-container matColumnDef="recibe">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-default dark:bg-gray-800/50 text-secondary font-black text-[10px] uppercase tracking-widest px-4 py-4 border-b dark:border-gray-800">
                        Destinatario
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-4 py-4 border-b dark:border-gray-800">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full flex items-center justify-center text-[11px] font-black text-white shadow-inner ring-2 ring-card overflow-hidden"
                                [style.background-color]="getUserDisplay(row.idUsuarioDestino).color"
                                [matTooltip]="getUserDisplay(row.idUsuarioDestino).name">
                                <img *ngIf="getUserDisplay(row.idUsuarioDestino).avatar"
                                    [src]="getUserDisplay(row.idUsuarioDestino).avatar"
                                    class="w-full h-full object-cover">
                                <span *ngIf="!getUserDisplay(row.idUsuarioDestino).avatar">
                                    {{ getUserDisplay(row.idUsuarioDestino).initials }}
                                </span>
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span
                                    class="text-[9px] font-bold text-blue-400 dark:text-blue-300 uppercase tracking-tighter leading-none mb-1">Destino</span>
                                <span
                                    class="text-[10px] font-black text-blue-900 dark:text-blue-200 truncate max-w-[100px]">{{
                                    row.almacenDestinoNombre }}</span>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Product Column -->
                <ng-container matColumnDef="product">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-default dark:bg-gray-800/50 text-secondary font-black text-[10px] uppercase tracking-widest px-4 py-4 border-b dark:border-gray-800">
                        Productos
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-4 py-4 border-b dark:border-gray-800">
                        <div class="flex flex-col gap-1 min-w-[180px]">
                            <div class="flex items-center gap-2">
                                <span
                                    class="text-[10px] font-black text-main uppercase leading-tight truncate max-w-[140px]">
                                    {{ row.detalles[0]?.nombreProducto }}
                                </span>
                                <span
                                    class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 text-[9px] px-1.5 py-0.5 rounded-md font-bold border border-blue-100 dark:border-blue-800">
                                    x{{ row.detalles[0]?.cantidadEnviada }}
                                </span>
                            </div>
                            <div class="flex items-center justify-between mt-1">
                                <span *ngIf="row.detalles.length > 1"
                                    class="text-[9px] font-bold text-hint uppercase tracking-tighter">
                                    +{{ row.detalles.length - 1 }} producto(s) más
                                </span>
                                <button mat-button
                                    class="!text-[9px] !font-black !text-blue-600 !h-6 !px-2 !min-w-0 hover:bg-blue-50 rounded-lg flex items-center gap-1"
                                    (click)="verDetalle(row)">
                                    <mat-icon class="!text-[12px] !w-3 !h-3">history</mat-icon>
                                    VER PROCESO
                                </button>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Logistics Column -->
                <ng-container matColumnDef="logistics">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-default dark:bg-gray-800/50 text-secondary font-black text-[10px] uppercase tracking-widest px-4 py-4 border-b dark:border-gray-800">
                        Logística
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-4 py-4 border-b dark:border-gray-800">
                        <div class="flex flex-col gap-1">
                            <span *ngIf="row.folioContpaqi"
                                class="text-[9px] font-black text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded border border-emerald-100 dark:border-emerald-800 w-fit flex items-center gap-1 uppercase">
                                <mat-icon class="!text-[10px] !w-[10px] !h-[10px]">receipt</mat-icon>
                                FOLIO CONTPAQI: {{ row.folioContpaqi }}
                            </span>
                            <span class="text-[10px] font-bold text-main uppercase flex items-center gap-1 italic">
                                <mat-icon
                                    class="!text-[11px] !w-[11px] !h-[11px] text-blue-500">local_shipping</mat-icon>
                                {{ row.transportista || 'Paquetería' }}
                            </span>
                            <span class="text-[9px] text-secondary font-medium uppercase tracking-tighter">
                                {{ row.fechaEnvio | date:'dd MMM, yyyy' }}
                            </span>
                        </div>
                    </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-default dark:bg-gray-800/50 text-secondary font-black text-[10px] uppercase tracking-widest px-4 py-4 border-b dark:border-gray-800 text-center">
                        Estatus
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-4 py-4 border-b dark:border-gray-800 text-center">
                        <span [ngClass]="getStatusClass(row.estadoId)"
                            class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest border shadow-sm">
                            {{ row.estadoNombre }}
                        </span>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-default dark:bg-gray-800/50 text-secondary font-black text-[10px] uppercase tracking-widest px-4 py-4 border-b dark:border-gray-800 text-center">
                        Acciones
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-4 py-4 border-b dark:border-gray-800 text-center">
                        <button *ngIf="row.estadoId === 1 || row.estadoId === 4" mat-flat-button color="primary"
                            class="!rounded-lg !text-[10px] !h-8 !px-4 hover:shadow-md transition-shadow uppercase tracking-widest font-black"
                            (click)="gestionarTraspaso(row)">
                            <mat-icon class="!text-xs !w-3 !h-3">settings</mat-icon> GESTIONAR
                        </button>

                        <div *ngIf="row.estadoId === 2 || row.estadoId === 3"
                            class="text-emerald-500 dark:text-emerald-400 text-[10px] font-black uppercase tracking-tighter flex items-center justify-center gap-1">
                            <mat-icon class="scale-75 align-middle">task_alt</mat-icon> {{ row.estadoId === 2 ?
                            'FINALIZADO'
                            : 'RECIBIDO (INCIDENCIA)' }}
                        </div>

                        <div *ngIf="row.estadoId === 5"
                            class="text-rose-500 dark:text-rose-400 text-[10px] font-black uppercase tracking-tighter flex items-center justify-center gap-1">
                            <mat-icon class="scale-75 align-middle">cancel</mat-icon> CANCELADO
                        </div>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                    class="hover:bg-hover transition-colors border-b dark:border-gray-800"></tr>
            </table>
        </div>
    </div>

    <div *ngIf="loading" class="p-16 flex flex-col items-center justify-center gap-3 bg-card">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
        <span class="text-xs font-bold text-hint uppercase tracking-widest font-mono">Sincronizando...</span>
    </div>

    <div *ngIf="transfers.length === 0 && !loading"
        class="p-20 text-center flex flex-col items-center justify-center bg-card">
        <mat-icon class="text-hint opacity-20 scale-[4] mb-12">inventory</mat-icon>
        <p class="text-hint uppercase text-[10px] font-black tracking-[0.3em]">No hay actividad de traspasos</p>
    </div>
</div>